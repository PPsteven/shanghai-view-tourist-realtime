<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>景点详情 - 上海旅游景点实时客流</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .back-btn {
            text-decoration: none;
            color: #606266;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .back-btn:hover {
            color: #409eff;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .info-item {
            background: #f9fafc;
            padding: 15px;
            border-radius: 4px;
        }
        .info-label {
            color: #909399;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .info-value {
            color: #303133;
            font-size: 16px;
            font-weight: 500;
        }
        #trend-chart {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">← 返回概览</a>
            <h1 id="spot-name">加载中...</h1>
            <div style="width: 60px;"></div> <!-- 占位 -->
        </div>

        <div class="card" id="info-card" style="display: none;">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">当前人数</div>
                    <div class="info-value" id="current-num">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">最大承载量</div>
                    <div class="info-value" id="max-num">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">舒适度</div>
                    <div class="info-value" id="ssd">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">等级</div>
                    <div class="info-value" id="grade">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">区域</div>
                    <div class="info-value" id="district">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">更新时间</div>
                    <div class="info-value" id="update-time">-</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>最近1个月客流趋势</h2>
            <div id="trend-chart"></div>
        </div>

        <div class="card">
            <h2>客流热力日历</h2>
            <div id="calendar-chart" style="width: 100%; height: 300px;"></div>
        </div>
    </div>

    <script>
        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const spotName = urlParams.get('name');

        if (!spotName) {
            alert('未指定景点名称');
            window.location.href = 'index.html';
        }

        document.getElementById('spot-name').textContent = spotName;
        document.title = `${spotName} - 客流详情`;

        // 初始化图表
        const chart = echarts.init(document.getElementById('trend-chart'));
        const calendarChart = echarts.init(document.getElementById('calendar-chart'));

        // 获取数据
        // 注意：文件名可能包含特殊字符，需要处理
        const safeName = spotName.replace(/\//g, '_').replace(/\\/g, '_');
        
        fetch(`data/spots/${encodeURIComponent(safeName)}.json`)
            .then(response => {
                if (!response.ok) throw new Error('Data not found');
                return response.json();
            })
            .then(jsonData => {
                const data = jsonData.data;
                if (!data || data.length === 0) {
                    document.querySelector('#trend-chart').innerHTML = '<p style="text-align:center;color:#909399;padding:50px;">暂无历史数据</p>';
                    return;
                }

                // 更新基本信息（使用最新一条数据）
                const latest = data[data.length - 1];
                document.getElementById('info-card').style.display = 'block';
                document.getElementById('current-num').textContent = latest.NUM;
                document.getElementById('max-num').textContent = latest.MAX_NUM;
                document.getElementById('ssd').textContent = latest.SSD;
                document.getElementById('grade').textContent = latest.GRADE || '-';
                document.getElementById('district').textContent = latest.DNAME || '-';
                document.getElementById('update-time').textContent = latest.TIME;

                renderChart(data);
                renderCalendarChart(data);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.querySelector('#trend-chart').innerHTML = '<p style="text-align:center;color:red;padding:50px;">加载数据失败，请确保已运行数据处理脚本。</p>';
            });

        function renderCalendarChart(data) {
            // 聚合每日峰值
            const dailyPeaks = {};
            let maxDateStr = '0000-00-00';
            let maxVal = 0;

            data.forEach(item => {
                // 假设 TIME 格式为 "YYYY-MM-DD HH:mm"
                const dateStr = item.TIME.split(' ')[0];
                const val = parseInt(item.NUM);
                
                if (!dailyPeaks[dateStr]) dailyPeaks[dateStr] = 0;
                dailyPeaks[dateStr] = Math.max(dailyPeaks[dateStr], val);
                
                if (dateStr > maxDateStr) maxDateStr = dateStr;
                maxVal = Math.max(maxVal, val);
            });

            const calendarData = Object.entries(dailyPeaks).map(([date, val]) => [date, val]);

            // 确定日历范围：仅显示当前自然月
            // 例如：如果最新数据是 2025-11-20，则显示 2025-11-01 到 2025-11-30
            const lastDate = new Date(maxDateStr);
            const year = lastDate.getFullYear();
            const month = lastDate.getMonth(); // 0-11
            
            // 当月第一天
            const firstDay = new Date(year, month, 1);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            
            // 当月最后一天 (下个月第0天)
            const lastDay = new Date(year, month + 1, 0);
            const lastDayStr = lastDay.toISOString().split('T')[0];

            const option = {
                tooltip: {
                    formatter: function (p) {
                        return p.value[0] + ': ' + p.value[1] + '人';
                    }
                },
                visualMap: {
                    min: 0,
                    max: maxVal,
                    type: 'piecewise',
                    orient: 'horizontal',
                    left: 'center',
                    top: 0,
                    inRange: {
                        color: ['#ebedf0', '#c6e48b', '#7bc96f', '#239a3b', '#196127']
                    }
                },
                calendar: {
                    top: 60,
                    left: 30,
                    right: 30,
                    cellSize: ['auto', 20],
                    range: [firstDayStr, lastDayStr], // 强制显示整个自然月
                    itemStyle: {
                        borderWidth: 0.5,
                        borderColor: '#ccc'
                    },
                    dayLabel: {
                        firstDay: 1, // 周一开始
                        nameMap: 'cn',
                        margin: 5,
                        position: 'end'
                    },
                    monthLabel: {
                        show: true,
                        nameMap: 'cn',
                        margin: 5
                    },
                    yearLabel: { show: false },
                    orient: 'vertical' // 垂直方向显示，星期作为列
                },
                series: {
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    data: calendarData
                }
            };
            calendarChart.setOption(option);
        }

        function renderChart(data) {
            const times = data.map(item => item.TIME);
            const values = data.map(item => item.NUM);

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const param = params[0];
                        return `${param.name}<br/>人数: ${param.value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: times,
                    axisLabel: {
                        formatter: function (value) {
                            // 如果是完整日期时间，尝试简化显示
                            // 假设格式 "YYYY-MM-DD HH:mm" 或 "MM-DD HH:mm"
                            if (value.length > 10) {
                                return value.substring(5); // 去掉年份
                            }
                            return value;
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '人数'
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 0,
                        end: 100
                    },
                    {
                        start: 0,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: '客流人数',
                        type: 'line',
                        smooth: true,
                        symbol: 'none',
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {
                                    offset: 0,
                                    color: 'rgba(64, 158, 255, 0.5)'
                                },
                                {
                                    offset: 1,
                                    color: 'rgba(64, 158, 255, 0.1)'
                                }
                            ])
                        },
                        itemStyle: {
                            color: '#409eff'
                        },
                        data: values
                    }
                ]
            };

            chart.setOption(option);
            
            window.addEventListener('resize', () => {
                chart.resize();
                calendarChart.resize();
            });
        }
    </script>
</body>
</html>
